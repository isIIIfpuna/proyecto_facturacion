<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalle-Venta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="p-4">

<div class="container p-0">
    <h3 class="text-center text-white p-2">Venta</h3>
    <div class="row m-0 text-white">
        <div class="col-md bg-warning p-3" id="datos-cliente">
            <p><strong>Nombre:</strong> <span id="cliente-nombre">-</span></p>
            <p><strong>Email:</strong> <span id="cliente-email">-</span></p>
            <p><strong>Teléfono:</strong> <span id="cliente-telefono">-</span></p>
            <p><strong>RUC-CI:</strong> <span id="cliente-ci">-</span></p>
        </div>
        <div class="col-md-6 bg-warning p-3">
            <label><strong>Tipo de Pago:</strong></label>
            <div>
                <input type="radio" name="tipoPago" id="contado" value="contado" disabled>
                <label for="contado">Contado</label>

                <input type="radio" name="tipoPago" id="credito" value="credito" class="ms-3" disabled>
                <label for="credito">Crédito</label>
            </div>

            <div id="opcionesCredito" class="mt-3 p-3 bg-success text-white d-none">
                <label><strong>Cantidad de Cuotas:</strong></label>
                <input type="number" id="cuotas" class="form-control mb-2" disabled>

                <label><strong>Fechas de Cobro:</strong></label>
                <ul id="lista-fechas" class="list-group"></ul>
            </div>
        </div>
    </div>

    <h4 class="text-center text-white p-2 mt-3">Detalle Venta</h4>

    <table class="table table-bordered">
        <thead class="table-secondary">
        <tr>
            <th>Producto</th>
            <th>Precio Unitario</th>
            <th>Cantidad</th>
            <th>SubTotal</th>
        </tr>
        </thead>
        <tbody id="detalle-productos">
        </tbody>
    </table>
    <div class="text-end mt-3">
        <h5 class="text-dark">Total: <span id="total-venta">Gs. 0</span></h5>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
        <button class="btn btn-secondary" onclick="window.location.href='listar-ventas.html'">Atrás</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const ventaId = urlParams.get("id");

        const opcionesCredito = document.getElementById("opcionesCredito");

        if (ventaId) {
            fetch(`http://localhost:8080/backend-inge3/sale/${ventaId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("cliente-nombre").textContent = data.customer.name || "-";
                    document.getElementById("cliente-email").textContent = data.customer.email || "-";
                    document.getElementById("cliente-telefono").textContent = data.customer.phone || "-";
                    document.getElementById("cliente-ci").textContent = data.customer.ci_ruc || "-";

                    const tipoPago = data.payment_type;
                    document.getElementById("contado").checked = tipoPago === "CO";
                    document.getElementById("credito").checked = tipoPago === "CR";

                    if (tipoPago === "CR") {
                        opcionesCredito.classList.remove("d-none");

                        // Llamar al endpoint para cuotas
                        fetch(`http://localhost:8080/backend-inge3/installment/invoice/${data.sale_id}`)
                            .then(response => response.json())
                            .then(cuotas => {
                                // Mostrar cantidad de cuotas
                                document.getElementById("cuotas").value = cuotas.length;

                                // Mostrar fechas formateadas
                                const listaFechas = document.getElementById("lista-fechas");
                                listaFechas.innerHTML = "";

                                cuotas.forEach(cuota => {
                                    const li = document.createElement("li");
                                    const fecha = new Date(cuota.due_date);
                                    const fechaFormateada = fecha.toLocaleDateString('es-PY', {
                                        day: '2-digit', month: '2-digit', year: 'numeric'
                                    });

                                    li.textContent = `Cuota ${cuota.installment_number}: ${fechaFormateada}`;
                                    li.classList.add("list-group-item", "bg-success", "text-white");
                                    listaFechas.appendChild(li);
                                });
                            })
                            .catch(err => {
                                console.error("Error al obtener cuotas:", err);
                            });
                    }

                    const tbody = document.getElementById("detalle-productos");
                    tbody.innerHTML = "";

                    data.sale_items.forEach(prod => {
                        const fila = document.createElement("tr");
                        fila.innerHTML = `
                            <td>${prod.product_name || prod.product_id}</td>
                            <td>${parseInt(prod.unit_price).toLocaleString('es-PY')}</td>
                            <td>${prod.quantity}</td>
                            <td>${parseInt(prod.sub_total).toLocaleString('es-PY')}</td>
                        `;
                        tbody.appendChild(fila);
                    });
                    // Mostrar el total de la venta
                    const totalVenta = document.getElementById("total-venta");
                    totalVenta.textContent = "Gs. " + parseInt(data.total_amount).toLocaleString('es-PY');
                })
                .catch(err => {
                    console.error("Error al cargar la venta:", err);
                    alert("Error al cargar datos de la venta.");
                });
        } else {
            alert("No se especificó un ID de venta en la URL.");
        }
    });
</script>

</body>
</html>
